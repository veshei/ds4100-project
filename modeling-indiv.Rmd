---
title: "ds-4100-project-modeling.Rmd"
author: "Veronica Shei, Edward Wang, Ethan Tang"
date: "3/23/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)
library(tidyverse)
library(RSQLite)
library(fTrading)
library(ggplot2)
library(quantmod)
library(corrplot)
library(caret)
library(class)
db <- dbConnect(SQLite(), dbname = "ds4100_project_db.sqlite")
```

```{r}
# database contains 619622 observations
master_dataset = dbReadTable(db,"AAPL")
master_dataset = master_dataset[,8:length(master_dataset)]
num_og_obs = dim(master_dataset)[1]
print(num_og_obs)
```

```{r}
dbListTables(db)
```

```{r}
# Removed 118329 NAs
num_curr_obs = dim(master_dataset)[1]
print(num_curr_obs)
print(num_og_obs - dim(master_dataset)[1])
master_dataset = na.omit(master_dataset)
print(num_og_obs - dim(master_dataset)[1])
master_dataset = master_dataset[master_dataset$PERCENT_VOL != 0,]
master_dataset = master_dataset[master_dataset$PERCENT_VOL < 1000,]
print(dim(master_dataset)[1])
```

```{r}
normalize <- function(ticker_df, type) {
  if(type == 'SMA') {
    sma <- ticker_df$SMA
    return ((sma - min(sma)) / (max(sma) - min(sma)))
  } else if (type == 'EWMA') {
      ewma <- ticker_df$EWMA
      return ((ewma - min(ewma)) / (max(ewma) - min(ewma)))
  } else if (type == 'PERCENT_PRICE') {
      price <- ticker_df$PERCENT_PRICE
      return ((price - min(price)) / (max(price) - min(price)))
  } else if (type == 'PERCENT_VOL') {
      vol <- ticker_df$PERCENT_VOL
      return ((vol - min(vol)) / (max(vol) - min(vol)))
  }
}
```

```{r}
master_dataset = cbind(master_dataset,
                       NORM_PERC_PRICE = normalize(master_dataset, "PERCENT_PRICE"),
                       NORM_PERC_VOL = normalize(master_dataset, "PERCENT_VOL"),
                       NORM_SMA = normalize(master_dataset, "SMA"),
                       NORM_EWMA = normalize(master_dataset, "EWMA")
                       )
```

```{r}
num_curr_obs = dim(master_dataset)[1]
num_curr_obs
master_dataset = master_dataset[master_dataset$SMA != 0,]
dim(master_dataset)[1]
master_dataset = master_dataset[master_dataset$MOM != 0,]
dim(master_dataset)[1]
master_dataset = master_dataset[master_dataset$RSI != 0,]
dim(master_dataset)[1]
master_dataset = master_dataset[master_dataset$RSI != 1,]
dim(master_dataset)[1]
```

```{r}
# determining a training size based on 70% of the dataset
training_perc = .70
training_size = round(dim(master_dataset)[[1]] * training_perc,0)

# creating a random index with the determined training size for selecting the training/testing set
training_idx = sample(nrow(master_dataset),size=training_size,replace=FALSE)
train_df = master_dataset[training_idx,]
test_df = master_dataset[-training_idx,]
```

```{r}
# Looking for correlations for numeric factors
master_dataset <- master_dataset %>%
  select(NORM_PERC_PRICE, NORM_PERC_VOL, NORM_SMA, NORM_EWMA, MOM, MACD, STOCH.K, STOCH.D, RSI, VOR,
         PERCENT_CHANGE_20, PERCENT_CHANGE_60, PERCENT_CHANGE_240,
         FUTURE_CLASS_20, FUTURE_CLASS_60, FUTURE_CLASS_240)
correlations <-  cor(master_dataset)
corrplot(correlations,"circle")
# correlations <-  cor(master_dataset %>%
#   select(NORM_PERC_PRICE, NORM_PERC_VOL, NORM_SMA, NORM_EWMA, MOM, MACD, STOCH.K, STOCH.D, RSI, VOR,
#          PERCENT_CHANGE_20))
# corrplot(correlations,"circle")
# 
# correlations <-  cor(master_dataset %>%
#   select(NORM_PERC_PRICE, NORM_PERC_VOL, NORM_SMA, NORM_EWMA, MOM, MACD, STOCH.K, STOCH.D, RSI, VOR,
#          PERCENT_CHANGE_60))
# corrplot(correlations,"circle")
# 
# correlations <-  cor(master_dataset %>%
#   select(NORM_PERC_PRICE, NORM_PERC_VOL, NORM_SMA, NORM_EWMA, MOM, MACD, STOCH.K, STOCH.D, RSI, VOR,
#          PERCENT_CHANGE_240))
# corrplot(correlations,"circle")
# 
# correlations <-  cor(master_dataset %>%
#   select(NORM_PERC_PRICE, NORM_PERC_VOL, NORM_SMA, NORM_EWMA, MOM, MACD, STOCH.K, STOCH.D, RSI, VOR,
#          FUTURE_CLASS_20))
# corrplot(correlations,"circle")
# 
# correlations <-  cor(master_dataset %>%
#   select(NORM_PERC_PRICE, NORM_PERC_VOL, NORM_SMA, NORM_EWMA, MOM, MACD, STOCH.K, STOCH.D, RSI, VOR,
#          FUTURE_CLASS_60))
# corrplot(correlations,"circle")
# 
# correlations <-  cor(master_dataset %>%
#   select(NORM_PERC_PRICE, NORM_PERC_VOL, NORM_SMA, NORM_EWMA, MOM, MACD, STOCH.K, STOCH.D, RSI, VOR,
#          FUTURE_CLASS_240))
# corrplot(correlations,"circle")
```

```{r}
# Linear Model Short
pred_lm_short <- step(lm(PERCENT_CHANGE_20 ~ NORM_PERC_PRICE + NORM_PERC_VOL + NORM_SMA + NORM_EWMA + MOM + MACD + STOCH.K + STOCH.D + RSI + VOR, train_df), direction = "both")

print(summary(pred_lm_short))
```

```{r}
# Linear Model Medium
pred_lm_med <- step(lm(PERCENT_CHANGE_60 ~ NORM_PERC_PRICE + NORM_PERC_VOL + NORM_SMA + NORM_EWMA + MOM + MACD + STOCH.K + STOCH.D + RSI + VOR, train_df), direction = "both")

print(summary(pred_lm_med))
```

```{r}
# Linear Model
pred_lm_long <- step(lm(PERCENT_CHANGE_240 ~ NORM_PERC_PRICE + NORM_PERC_VOL + NORM_SMA + NORM_EWMA + MOM + MACD + STOCH.K + STOCH.D + RSI + VOR, train_df), direction = "both")

print(summary(pred_lm_long))
```

```{r}
# Logistic Model short
pred_glm_short <- step(glm(FUTURE_CLASS_20 ~ NORM_PERC_PRICE + NORM_PERC_VOL + NORM_SMA + NORM_EWMA + MOM + MACD + STOCH.K + STOCH.D + RSI + VOR, train_df, family=binomial), direction = "both")

print(summary(pred_glm_short))
```

```{r}
# testing model against test dataset
# rounding applies a threshold of 50% probability for survival
predicted <- round(predict(pred_glm_short, test_df, type="response"),0)
# place predictions and actual class into a dataframe
results <- data.frame(predicted, actual=test_df$FUTURE_CLASS_20)
head(results)
# Confusion Matrix with stats
confusionMatrix(factor(predicted), factor(test_df$FUTURE_CLASS_20))
```

```{r}
pred_glm_med <- step(glm(FUTURE_CLASS_60 ~ NORM_PERC_PRICE + NORM_PERC_VOL + NORM_SMA + NORM_EWMA + MOM + MACD + STOCH.K + STOCH.D + RSI + VOR, train_df, family=binomial), direction = "both")

print(summary(pred_glm_med))
```

```{r}
# testing model against test dataset
# rounding applies a threshold of 50% probability for survival
predicted <- round(predict(pred_glm_med, test_df, type="response"),0)
# place predictions and actual class into a dataframe
results <- data.frame(predicted, actual=test_df$FUTURE_CLASS_60)
head(results)
# Confusion Matrix with stats
confusionMatrix(factor(predicted), factor(test_df$FUTURE_CLASS_60))
```

```{r}
pred_glm_long <- step(glm(FUTURE_CLASS_240 ~ NORM_PERC_PRICE + NORM_PERC_VOL + NORM_SMA + NORM_EWMA + MOM + MACD + STOCH.K + STOCH.D + RSI + VOR, train_df, family=binomial), direction = "both")

print(summary(pred_glm_long))
```

```{r}
# testing model against test dataset
# rounding applies a threshold of 50% probability for survival
predicted <- round(predict(pred_glm_long, test_df, type="response"),0)
# place predictions and actual class into a dataframe
results <- data.frame(predicted, actual=test_df$FUTURE_CLASS_240)
head(results)
# Confusion Matrix with stats
confusionMatrix(factor(predicted), factor(test_df$FUTURE_CLASS_240))
```

```{r}
#Predict classes of samples with class package
predicted = knn(train_df[,1:10],test_df[,1:10],train_df$FUTURE_CLASS_20,k=11)
predicted
# place predictions and actual class into a dataframe
results <- data.frame(predicted, actual=test_df$FUTURE_CLASS_240)
head(results)
# Confusion Matrix with stats
confusionMatrix(factor(predicted), factor(test_df$FUTURE_CLASS_240))
```

```{r}
#Predict classes of samples with class package
predicted = knn(train_df[,1:10],test_df[,1:10],train_df$FUTURE_CLASS_60,k=11)
predicted
# place predictions and actual class into a dataframe
results <- data.frame(predicted, actual=test_df$FUTURE_CLASS_240)
head(results)
# Confusion Matrix with stats
confusionMatrix(factor(predicted), factor(test_df$FUTURE_CLASS_240))
```

```{r}
#Predict classes of samples with class package
predicted = knn(train_df[,1:10],test_df[,1:10],train_df$FUTURE_CLASS_240,k=11)
predicted
# place predictions and actual class into a dataframe
results <- data.frame(predicted, actual=test_df$FUTURE_CLASS_240)
head(results)
# Confusion Matrix with stats
confusionMatrix(factor(predicted), factor(test_df$FUTURE_CLASS_240))
```

