---
title: "ds-4100-project.Rmd"
author: "Veronica Shei, Edward Wang, Ethan Tang"
date: "3/23/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)
library(tidyverse)
library(RSQLite)
library(fTrading)
library(ggplot2)
db <- dbConnect(SQLite(), dbname = "ds4100_project_db.sqlite")
```

#retrieve S&P 500 company tickers
```{r}
sp500_page <- read_html("https://en.wikipedia.org/wiki/List_of_S%26P_500_companies")
sp500_tickers <- sp500_page %>% html_nodes("#constituents td:nth-child(2)") %>% html_text()
sp500_tickers
```

#get tibble of dates, adj closing price, and volume for given ticker.
```{r}
get_stock_data <- function(ticker) {
  
  yahoo_finance_url <- paste("https://finance.yahoo.com/quote/", ticker, "/history?period1=915339600&period2=1553313600&interval=1mo&filter=history&frequency=1mo", sep = "")
  page <- read_html(yahoo_finance_url)
  
  div_dates <- get_div_dates(ticker)
  split_dates <- get_split_dates(ticker)
  
  root <- html_node(page, 'body')
  body <- root %>% html_nodes('tbody tr')

  #returns the dates, removing dates that correspond to dividends
  
  format_month <- c("Jan"="01","Feb"="02","Mar"="03","Apr"="04","May"="05","Jun"="06","Jul"="07","Aug"="08","Sep"="09","Oct"="10","Nov"="11","Dec"="12")
  
  
  dates <- body %>% html_nodes('td:nth-child(1)') %>% html_text()
  dates <- dates[which(!(dates %in% div_dates))]
  dates <- dates[which(!(dates %in% split_dates))] %>% str_replace_all(format_month) %>% str_replace("\\s01,\\s","/01/") %>% str_remove_all("\\s") %>% str_remove("20") %>% as.Date("%m/%d/%y")
  
  highs <- body %>% html_nodes('td:nth-child(3)') %>% html_text() %>% str_replace_all(",","") %>% as.numeric()
  lows <- body %>% html_nodes('td:nth-child(4)') %>% html_text() %>% str_replace_all(",","") %>% as.numeric()
  Adjusted_Closes <- body %>% html_nodes('td:nth-child(6)') %>% html_text() %>% str_replace_all(",","") %>% as.numeric()
  volumes <- body %>% html_nodes('td:nth-child(7)') %>% html_text() %>% str_replace_all(",","") %>% as.numeric()

  tibble(
    Date = dates,
    Adjusted_Close = Adjusted_Closes,
    Volume = volumes,
    High = highs,
    Low = lows
  )
}

#returns a list of dividend dates. we want to remove these dates from the historical data
get_div_dates <- function(ticker) {
  yahoo_finance_div_url <- paste("https://finance.yahoo.com/quote/", ticker, "/history?period1=915339600&period2=1553313600&interval=1mo&filter=div&frequency=1mo", sep = "")
  
  read_html(yahoo_finance_div_url) %>% html_node('body') %>% html_nodes('tbody tr td:nth-child(1)') %>% html_text()
}

#returns a list of stock dates. we want to remove these dates from the historical data
get_split_dates <- function(ticker) {
  yahoo_finance_split_url <- paste("https://finance.yahoo.com/quote/", ticker, "/history?period1=915339600&period2=1553313600&interval=1mo&filter=split&frequency=1mo", sep = "")
  
  read_html(yahoo_finance_split_url) %>% html_node('body') %>% html_nodes('tbody tr td:nth-child(1)') %>% html_text()
}
```

```{r}
get_SMA <- function(ticker_df) {
  pad <- c(0,0,0,0)
  sma <- SMA(ticker_df$Adjusted_Close) #simple moving average
  c(pad, sma)
}
```

```{r}
# need to normalize before
get_EWMA <- function(ticker_df) {
  EWMA(ticker_df$Adjusted_Close, lambda = .1) #exponentially weighted moving average
}
```

```{r}
MOM <- function(ticker_df) {
  momTA(ticker_df$Adjusted_Close) #momentum 
}
```

```{r}
MACD <- function(ticker_df) {
  macdTA(ticker_df$Adjusted_Close) #moving average conversion to divergents
}
```

```{r}
VOR <- function(ticker_df) {
  vorTA(ticker_df$High, ticker_df$Low) #volatility ratio
}
```

```{r}
STOCH <- function(ticker_df) {
  stochasticTA(ticker_df$Adjusted_Close, ticker_df$High, ticker_df$Low)
}
```

```{r}
RSI <- function(ticker_df){
  rsiTA(ticker_df$Adjusted_Close) #relative strength index
}
```

```{r}
sp500_tickers <- sp500_tickers[1:1]

for(ticker in sp500_tickers) {
  df <- get_stock_data(ticker)
  df <- cbind(df,
              SMA = get_SMA(df),
              EWMA = get_EWMA(df),
              MOM = MOM(df),
              MACD = MACD(df),
              STOCH = STOCH(df),
              RSI = RSI(df),
              VOR = VOR(df)
              )
  assign(paste(ticker,"_df", sep = ""),df)
}
MMM_df
```

```{r, table_setup, message=FALSE, echo=TRUE, warning=FALSE}
#Code to setup all the tables we plan to use in SQLite
for (curr_tick in sp500_tickers) {
  ticker_query <- paste(
    "CREATE TABLE IF NOT EXISTS [", curr_tick,
    "] (Ticker TEXT PRIMARY KEY,
    Date TEXT
    Adjusted_Close INTEGER,
    Volume INTEGER,
    High INTEGER,
    Low INTEGER,
    PERCENT_VOL INTEGER,
    PERCENT_PRICE INTEGER,
    NORM_SMA INTEGER,
    NORM_EMA INTEGER,
    SMA INTEGER,
    EWMA INTEGER,
    MOM INTEGER,
    MACD INTEGER,
    STOCHK INTEGER,
    STOCHD INTEGER,
    RSI INTEGER,
    VOR INTEGER)", sep="")
  dbSendQuery(ds4100_project_db, ticker_query)
}
```

```{r}
ggplot(data = MMM_df, mapping = aes(x = Date, y = EWMA)) + 
  geom_point() +
  geom_smooth(method = "glm") + theme(axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(data = MMM_df, mapping = aes(x = Date, y = SMA)) + 
  geom_point() +
  geom_smooth(method = "glm") + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```