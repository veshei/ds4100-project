---
title: "ds-4100-project.Rmd"
author: "Veronica Shei, Edward Wang, Ethan Tang"
date: "3/23/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(alphavantager)
library(rvest)
library(tryCatchLog)
library(tidyverse)
av_api_key("KEI93A3FCAX5K5R9")
```

#retrieve S&P 500 company tickers
```{r}
sp500_page <- read_html("https://en.wikipedia.org/wiki/List_of_S%26P_500_companies")
sp500_names <- sp500_page %>% html_nodes("#constituents td:nth-child(2)") %>% html_text()
```

```{r}
# Alpha Vantage API key: KEI93A3FCAX5K5R9
av_get(symbol = "^GSPC", av_fun = "TIME_SERIES_DAILY_ADJUSTED", interval = "60min", outputsize = "full")
```

```{r}
av_get(av_fun = "SECTOR")
```

#loop through the sp500 names and pulls adj closing and volume for that stock.
```{r}
get_sp500_price_and_volume <- function() {
  count_until_pause <- 15
  for (n in sp500_names) {
    #alphavantage has max 5 per minute. Waits so we can call again
    if (count_until_pause == 1) {
      Sys.sleep(61)
      count_until_pause <- 15
    }
  
    # get ticker data. Alternate between keys 
    if (count_until_pause <= 5) {
      data_get(n, 1)
    } else if (count_until_pause <= 10) {
      data_get(n, 2)
    } else {
      data_get(n, 3)
    }
    
    count_until_pause <- count_until_pause - 1
  }
}

data_get <- function(ticker, current_key) {
  print(switch (current_key, "KEI93A3FCAX5K5R9", "UKGGXP46EHI7K1FB", "1MS48Q9F2SIQSHK7"))
  
  #av_get(symbol = ticker, av_fun = "AD", interval = "monthly", time_period = 60)
}
```